#/usr/bin/env bash
cd $(dirname $0)/..
set -euo pipefail

TARGET_NAME=runtime
OUTPUT_DIR=./build

# Expand macros in .wat source code
echo "Expanding macros..."
node ./scripts/compile.mjs "./src/$TARGET_NAME.wat" > "$OUTPUT_DIR/$TARGET_NAME.build.wat"

# Convert to binary .wasm module
echo "Converting to WebAssembly bytecode..."
wat2wasm "$OUTPUT_DIR/$TARGET_NAME.build.wat" --debug-names --output "$OUTPUT_DIR/$TARGET_NAME.build.wasm"

# Inline initial heap snapshot into .wasm module
echo "Inlining heap snapshot..."
cargo run --quiet --bin snapshot -- --memory-name "memory" --inline-globals --input "$OUTPUT_DIR/$TARGET_NAME.build.wasm" --output "$OUTPUT_DIR/$TARGET_NAME.wasm"

echo "Compiled $OUTPUT_DIR/$TARGET_NAME.wasm"
